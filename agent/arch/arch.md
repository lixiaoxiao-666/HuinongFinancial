# 数字惠农APP及OA后台管理系统 - 系统架构文档

## 1. 架构概述

### 1.1 整体架构设计

本系统采用单体架构设计，避免微服务的复杂性，确保在网络条件较差的农村地区也能稳定运行。系统包含三个核心部分：

- **数字惠农APP**：基于Vue3开发的移动端应用
- **惠农OA后台管理系统**：基于Vue3+Element Plus的Web管理平台  
- **后端服务**：基于Golang+Gin+GORM的单体服务，集成Dify AI平台

### 1.2 技术约束条件

根据需求文档，系统必须满足以下技术约束：
- 不采用微服务架构，使用单体架构
- 数据库设计避免冗余，采用规范化设计
- 必须支持无网络环境下的基本功能运行
- 集成Dify AI平台进行智能审批

## 2. 技术栈选型

### 2.1 后端技术栈
- **语言框架**：Golang 1.21+ + Gin Web框架
- **ORM框架**：GORM v2 
- **数据库**：TiDB (兼容MySQL协议)
- **缓存**：Redis 7.x
- **配置管理**：Viper
- **日志**：Logrus + 日志轮转
- **文档**：Swagger/OpenAPI 3.0

### 2.2 前端技术栈
- **移动端APP**：Vue3 + Vant4 + TypeScript + Vite
- **OA管理后台**：Vue3 + Element Plus + TypeScript + Vite  
- **状态管理**：Pinia
- **HTTP客户端**：Axios
- **路由**：Vue Router 4

### 2.3 基础设施
- **容器化**：Docker + Docker Compose
- **反向代理**：Nginx
- **文件存储**：本地存储 + 阿里云OSS (可选)
- **监控**：Prometheus + Grafana (可选)

## 3. 核心架构设计

### 3.1 整体架构图

```
┌─────────────────┐    ┌─────────────────┐
│   数字惠农APP   │    │   OA管理后台     │
│   (Vue3+Vant)   │    │ (Vue3+Element)  │
└─────────┬───────┘    └─────────┬───────┘
          │                      │
          │    HTTPS/API 调用    │
          └──────────┬───────────┘
                     │
        ┌────────────▼────────────┐
        │     Golang后端服务       │
        │   (Gin + GORM框架)      │
        └─────────┬───────────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
    ▼             ▼             ▼
┌─────────┐  ┌─────────┐  ┌─────────────┐
│  TiDB   │  │  Redis  │  │  Dify AI    │
│ 数据库  │  │  缓存   │  │  平台        │
└─────────┘  └─────────┘  └─────────────┘
```

### 3.2 离线优先架构策略

#### 3.2.1 本地数据同步机制
- **离线队列**：使用本地SQLite存储离线操作队列
- **数据优先级**：用户基本信息、贷款历史、农机信息等核心数据优先缓存
- **增量同步**：网络恢复后进行增量数据同步
- **冲突解决**：采用时间戳和版本号解决数据冲突

#### 3.2.2 离线数据存储策略
```
离线数据存储结构：
├── 用户认证信息 (JWT Token、基本资料)
├── 贷款产品信息 (产品列表、利率信息)  
├── 历史申请记录 (审批状态、申请详情)
├── 农机租赁信息 (可租设备、价格信息)
└── 离线操作队列 (待同步的用户操作)
```

## 4. 系统模块设计

### 4.1 核心业务模块

#### 4.1.1 用户服务模块 (UserService)
- **功能**：用户注册、登录、实名认证、权限管理
- **特性**：JWT认证、多平台登录、角色权限控制
- **离线支持**：用户基本信息本地缓存

#### 4.1.2 贷款服务模块 (LoanService)  
- **功能**：贷款产品管理、申请处理、审批流程、AI集成
- **特性**：Dify AI自动审批、人工审核、状态流转
- **离线支持**：申请草稿本地保存，网络恢复后提交

#### 4.1.3 农机服务模块 (MachineService)
- **功能**：农机信息管理、租赁订单处理、地理定位
- **特性**：实时库存、价格计算、GPS定位
- **离线支持**：农机基本信息缓存、离线浏览

#### 4.1.4 内容管理模块 (ContentService)
- **功能**：农业资讯、政策发布、专家信息管理
- **特性**：分类管理、搜索功能、推送通知
- **离线支持**：重要资讯本地缓存

#### 4.1.5 Dify集成模块 (DifyService)
- **功能**：AI工作流调用、审批决策、风险评估
- **特性**：异步调用、重试机制、降级处理
- **集成方式**：RESTful API + Webhook回调

#### 4.1.6 离线同步模块 (SyncService)
- **功能**：数据同步、冲突解决、网络检测
- **特性**：断点续传、增量同步、自动重试
- **策略**：后台自动同步 + 手动触发同步

### 4.2 数据流转设计

#### 4.2.1 贷款申请流程
```
APP提交申请 → 后端验证 → 存储数据库 → 调用Dify AI → 
AI审批决策 → 结果回调 → 状态更新 → 通知用户
```

#### 4.2.2 离线数据流
```
离线操作 → 本地队列 → 网络检测 → 
数据上传 → 服务器处理 → 结果同步 → 本地更新
```

## 5. Dify AI平台集成设计

### 5.1 集成架构

#### 5.1.1 调用方式
- **主动调用**：OA系统调用Dify工作流API
- **被动回调**：Dify通过Webhook回调OA系统接口
- **数据格式**：JSON格式数据交换
- **认证方式**：API Key + 请求签名验证

#### 5.1.2 工作流设计
```
Dify AI工作流节点：
1. 接收审批请求 → 2. 获取用户信息 → 3. 风险评估 → 
4. 规则匹配 → 5. 决策输出 → 6. 结果回调
```

### 5.2 API接口设计

#### 5.2.1 OA调用Dify接口
```http
POST /v1/workflows/run
Authorization: Bearer {API_KEY}
Content-Type: application/json

{
  "inputs": {
    "user_id": "12345",
    "loan_amount": 50000,
    "loan_purpose": "农资采购",
    "credit_score": 750
  },
  "response_mode": "blocking",
  "user": "oa_system"
}
```

#### 5.2.2 Dify回调OA接口
```http
POST /api/v1/dify/callback
Content-Type: application/json
X-Dify-Signature: {SIGNATURE}

{
  "workflow_id": "loan_approval",
  "request_id": "req_12345",
  "status": "completed",
  "result": {
    "risk_level": "low",
    "decision": "approved",
    "confidence": 0.85,
    "reasons": ["良好信用记录", "稳定收入来源"]
  }
}
```

### 5.3 异常处理机制

#### 5.3.1 网络异常处理
- **超时重试**：指数退避重试策略
- **熔断机制**：连续失败后自动熔断
- **降级策略**：AI服务不可用时转人工审批

#### 5.3.2 数据一致性保证
- **幂等性**：所有API调用支持幂等
- **事务管理**：关键操作使用数据库事务
- **状态同步**：定期同步Dify处理状态

## 6. 数据库架构设计

### 6.1 数据库选型：TiDB
- **选择理由**：兼容MySQL、支持水平扩展、ACID事务
- **部署模式**：单节点部署，后期可扩展为集群
- **连接池**：连接池大小动态调整

### 6.2 缓存策略：Redis
- **缓存类型**：数据缓存、会话缓存、分布式锁
- **过期策略**：LRU + TTL组合策略
- **持久化**：RDB + AOF双重持久化

### 6.3 数据分层设计
```
┌─────────────────┐
│   应用层缓存     │ ← Redis缓存热点数据
├─────────────────┤
│   业务逻辑层     │ ← Go服务业务处理  
├─────────────────┤
│   数据访问层     │ ← GORM ORM映射
├─────────────────┤  
│   数据存储层     │ ← TiDB关系型存储
└─────────────────┘
```

## 7. 安全架构设计

### 7.1 认证与授权
- **用户认证**：JWT Token + 手机验证码
- **权限模型**：RBAC角色权限控制
- **会话管理**：Token过期 + 刷新机制

### 7.2 数据安全
- **传输加密**：全站HTTPS + TLS 1.3
- **存储加密**：敏感数据AES-256加密
- **脱敏展示**：身份证、银行卡等脱敏显示

### 7.3 API安全
- **请求签名**：防篡改签名验证
- **频率限制**：基于用户和IP的限流
- **防护机制**：防止SQL注入、XSS攻击

## 8. 性能优化策略

### 8.1 应用层优化
- **连接池**：数据库连接池优化
- **缓存策略**：多级缓存架构
- **异步处理**：耗时操作异步化

### 8.2 数据库优化
- **索引策略**：合理创建数据库索引
- **查询优化**：SQL语句性能调优
- **分页查询**：大数据量分页处理

### 8.3 网络优化
- **CDN加速**：静态资源CDN分发
- **Gzip压缩**：HTTP响应压缩
- **Keep-Alive**：HTTP长连接复用

## 9. 部署架构

### 9.1 单体部署架构
```
┌─────────────────────────────────────┐
│              Nginx                  │
│          (反向代理+静态文件)          │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│           Golang Application        │
│         (Docker Container)          │
└─────────────────┬───────────────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
    ▼             ▼             ▼
┌─────────┐  ┌─────────┐  ┌─────────┐
│  TiDB   │  │  Redis  │  │ 文件存储 │
│Container│  │Container│  │ Volume  │
└─────────┘  └─────────┘  └─────────┘
```

### 9.2 容器化部署
- **基础镜像**：Alpine Linux
- **多阶段构建**：减小镜像体积
- **健康检查**：容器健康状态监控
- **资源限制**：内存和CPU限制

## 10. 监控与运维

### 10.1 监控指标
- **应用指标**：QPS、响应时间、错误率
- **系统指标**：CPU、内存、磁盘、网络
- **业务指标**：用户活跃度、申请成功率

### 10.2 日志管理
- **结构化日志**：JSON格式统一输出
- **日志分级**：Debug/Info/Warn/Error
- **日志轮转**：按大小和时间轮转
- **日志收集**：ELK Stack集中收集(可选)

### 10.3 备份策略
- **数据备份**：每日自动数据库备份
- **文件备份**：上传文件定期备份
- **配置备份**：系统配置版本控制

## 11. 扩展性设计

### 11.1 水平扩展能力
- **无状态设计**：应用服务无状态化
- **数据库扩展**：TiDB支持水平扩展
- **缓存扩展**：Redis集群支持

### 11.2 功能扩展点
- **插件架构**：预留业务插件扩展点
- **API版本**：支持多版本API共存
- **配置化**：核心参数配置化管理

## 12. 灾备方案

### 12.1 高可用设计
- **多副本部署**：关键服务多实例部署
- **故障转移**：自动故障检测和转移
- **数据冗余**：数据多副本存储

### 12.2 灾难恢复
- **备份恢复**：定期备份验证和恢复演练
- **异地备份**：关键数据异地备份
- **恢复时间**：RTO < 4小时，RPO < 1小时

## 13. 总结

本架构设计充分考虑了农村地区的网络环境特点，采用离线优先的设计理念，确保系统在各种网络条件下都能稳定运行。同时，通过与Dify AI平台的深度集成，实现了智能化的贷款审批流程，提高了业务处理效率。整体架构具备良好的扩展性和维护性，能够支撑业务的长期发展。 