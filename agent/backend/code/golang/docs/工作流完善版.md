# Dify 贷款审批工作流完善版（优化版）

## 工作流概述
本文档提供了优化后的Dify贷款审批工作流配置，采用更简洁的流程设计：直接将申请详情提交给AI智能体，由AI统一处理所有评估逻辑并输出结构化结果。

## 优化亮点
1. **流程简化**: 从9个节点简化为5个节点
2. **AI统一决策**: 将认证检查、风险评估、决策判断全部交给AI处理
3. **减少错误点**: 减少数据传递环节，降低出错概率
4. **提高效率**: 减少节点间的数据解析和转换

## 节点配置详情

### 节点1：开始节点 (start)
**节点类型**: Start
**输入变量**:
```json
{
  "application_id": {
    "type": "string",
    "required": true,
    "description": "贷款申请ID"
  },
  "user_id": {
    "type": "string", 
    "required": true,
    "description": "用户ID"
  }
}
```

### 节点2：获取申请详情 (get_application_details)
**节点类型**: Tool
**工具名称**: `get_loan_application_details`
**输入映射**:
```json
{
  "application_id": "{{#start.application_id#}}",
  "user_id": "{{#start.user_id#}}",
  "include_credit": true
}
```
**输出变量**: `application_response` (包含完整的JSON响应)

### 节点3：AI智能评估 (ai_smart_assessment)
**节点类型**: LLM
**模型**: GPT-4o
**输入变量**:
- `application_data`: `{{#get_application_details.text#}}`

**系统提示词**:
```
你是专业的农业金融风险评估专家。你将收到完整的贷款申请JSON数据，需要进行全面评估并做出审批决策。

## 评估流程
1. **数据解析**: 从JSON中提取关键信息
2. **认证检查**: 检查用户认证完整度
3. **风险评估**: 分析信用、财务、经验等风险因素
4. **决策判断**: 基于评估结果做出approve/manual/reject决策
5. **输出建议**: 提供具体的审批参数和意见

## 评估规则

### 认证要求
- 实名认证、银行卡认证、征信认证必须全部完成才能批准
- 认证不完整直接拒绝

### 风险等级标准

**低风险 (approve) - 直接批准**
必须同时满足：
- 认证完整度：完全认证
- 信用评分 >= 700
- 负债收入比 <= 0.3
- 农业经验 >= 3年
- 无逾期记录或逾期次数 <= 1且天数 <= 30
- 月供压力 <= 30%

**中风险 (manual) - 人工审核**
认证完整且满足：
- 信用评分 600-699
- 负债收入比 0.3-0.5
- 农业经验 1-3年
- 逾期次数 <= 2且最大逾期天数 <= 90
- 月供压力 30-50%

**高风险 (reject) - 直接拒绝**
满足以下任一条件：
- 认证信息不完整
- 信用评分 < 600
- 负债收入比 > 0.5
- 农业经验 < 1年
- 逾期次数 > 2或最大逾期天数 > 90
- 月供压力 > 50%

## 推荐策略
- **低风险**: 批准全额或适当金额，给予利率优惠(8-10%)
- **中风险**: 批准部分金额(50-80%)，标准利率(10-12%)，建议加强监控
- **高风险**: 拒绝申请，详细说明原因和改进建议

## 输出要求
必须严格按照以下JSON格式输出，不要包含任何其他文字：
{
  "risk_level": "low|medium|high",
  "decision": "approve|manual|reject",
  "recommended_amount": 推荐金额数字(approve/manual时必填),
  "recommended_term": 推荐期限数字(approve/manual时必填),
  "recommended_rate": 推荐年利率数字(approve/manual时必填),
  "risk_factors": ["风险因素1", "风险因素2"],
  "comments": "详细评估意见，包括决策理由和建议",
  "confidence_score": 置信度数字(0-1之间),
  "auth_status": "complete|partial|incomplete",
  "key_metrics": {
    "credit_score": 信用评分,
    "debt_ratio": 负债收入比,
    "experience_years": 农业经验年数,
    "monthly_payment_ratio": 月供收入比
  }
}
```

**用户提示词**:
```
请对以下贷款申请进行全面评估：

## 申请详情数据
{{#get_application_details.text#}}

## 评估要求
1. 仔细解析JSON数据，提取所有关键信息
2. 首先检查认证状态(real_name_verified, bank_card_verified, credit_verified)
3. 如果认证不完整，直接拒绝并说明原因
4. 如果认证完整，进行详细的风险评估
5. 计算关键指标：负债收入比、月供压力、信用风险等
6. 根据评估规则做出决策
7. 提供具体的审批建议和参数

请严格按照JSON格式输出完整的评估结果。
```

**输出变量**:
- `ai_assessment` (Object): AI评估结果对象

### 节点4：提交评估结果 (submit_assessment)
**节点类型**: Tool
**工具名称**: `submit_risk_assessment`
**输入映射**:
```json
{
  "application_id": "{{#start.application_id#}}",
  "risk_level": "{{#ai_smart_assessment.risk_level#}}",
  "decision": "{{#ai_smart_assessment.decision#}}",
  "recommended_amount": "{{#ai_smart_assessment.recommended_amount#}}",
  "recommended_term": "{{#ai_smart_assessment.recommended_term#}}",
  "recommended_rate": "{{#ai_smart_assessment.recommended_rate#}}",
  "risk_factors": "{{#ai_smart_assessment.risk_factors#}}",
  "comments": "{{#ai_smart_assessment.comments#}}",
  "confidence_score": "{{#ai_smart_assessment.confidence_score#}}"
}
```

### 节点5：结束节点 (end)
**节点类型**: End
**输出变量**:
```json
{
  "workflow_result": "{{#submit_assessment.text#}}",
  "ai_assessment": "{{#ai_smart_assessment#}}",
  "final_decision": "{{#ai_smart_assessment.decision#}}",
  "final_risk_level": "{{#ai_smart_assessment.risk_level#}}",
  "application_id": "{{#start.application_id#}}",
  "processing_status": "completed",
  "processing_timestamp": "{{sys.current_time}}"
}
```

## 节点连接流程

```
start(节点1)
    ↓
get_application_details(节点2)
    ↓
ai_smart_assessment(节点3)
    ↓
submit_assessment(节点4)
    ↓
end(节点5)
```

## 优化特性

1. **一站式AI决策**: AI直接处理原始数据，包含所有业务逻辑
2. **结构化输出**: AI直接输出标准化的评估对象
3. **简化数据流**: 减少中间数据转换，提高可靠性
4. **智能认证检查**: AI自动判断认证状态并相应处理
5. **综合风险评估**: 将所有风险因素集成在一个评估环节
6. **灵活决策**: AI可以根据具体情况灵活调整评估策略

## 测试用例

### 测试用例1：认证完整、低风险用户
```json
{
  "application_id": "LA20250530001",
  "user_id": "user_123"
}
```
预期结果：decision = "approve", risk_level = "low"

### 测试用例2：认证不完整用户
```json
{
  "application_id": "LA20250530002", 
  "user_id": "user_456"
}
```
预期结果：decision = "reject", auth_status = "incomplete"

### 测试用例3：认证完整、中等风险用户
```json
{
  "application_id": "LA20250530003",
  "user_id": "user_789"
}
```
预期结果：decision = "manual", risk_level = "medium"

## 监控指标

1. **工作流执行时间**: 目标 < 30秒
2. **AI响应准确性**: 目标 > 95%
3. **决策一致性**: 与专家评估对比
4. **异常处理率**: 目标 < 5%

## 部署建议

1. **AI模型选择**: 推荐使用GPT-4o或Claude-3-Opus
2. **超时设置**: LLM节点超时设置为60秒
3. **重试机制**: 启用自动重试，最多3次
4. **日志记录**: 保存完整的AI输入输出用于审计
5. **A/B测试**: 与原有流程并行运行一段时间进行对比

这个优化版本大大简化了工作流，提高了效率和可维护性，同时保持了评估的准确性和完整性。 