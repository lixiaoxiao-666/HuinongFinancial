# å†œæœºç§Ÿèµå’Œè´·æ¬¾å®¡æ‰¹ç³»ç»Ÿå®Œæ•´å®ç°

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†å®Œæ•´çš„å†œæœºç§Ÿèµå®¡æ‰¹ã€è´·æ¬¾ç”³è¯·å®¡æ‰¹æœåŠ¡åŠŸèƒ½ï¼Œå¹¶ä¸ä»»åŠ¡ç®¡ç†ç³»ç»Ÿé›†æˆï¼Œä¸ºDifyå·¥ä½œæµæä¾›å®Œæ•´çš„è‡ªåŠ¨å®¡æ‰¹èƒ½åŠ›ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Difyå·¥ä½œæµ    â”‚â”€â”€â”€â”€â”‚   Handlerå±‚     â”‚â”€â”€â”€â”€â”‚   Serviceå±‚     â”‚
â”‚   è‡ªåŠ¨å®¡æ‰¹      â”‚    â”‚   APIæ¥å£      â”‚    â”‚   ä¸šåŠ¡é€»è¾‘      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Routerå±‚       â”‚    â”‚   æ•°æ®æ¨¡å‹      â”‚
                    â”‚   è·¯ç”±é…ç½®       â”‚    â”‚   ç±»å‹å®šä¹‰      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. å†œæœºç§Ÿèµå®¡æ‰¹ç³»ç»Ÿ

#### åŠŸèƒ½ç‰¹æ€§
- âœ… ç§Ÿèµç”³è¯·åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ”¯æŒå¤šæ¡ä»¶ç­›é€‰ï¼‰
- âœ… ç§Ÿèµç”³è¯·è¯¦æƒ…æŸ¥çœ‹ï¼ˆåŒ…å«é£é™©è¯„ä¼°ï¼‰
- âœ… å•ä¸ªç”³è¯·å®¡æ‰¹ï¼ˆæ‰¹å‡†/æ‹’ç»ï¼‰
- âœ… æ‰¹é‡å®¡æ‰¹å¤„ç†
- âœ… ç§Ÿèµç»Ÿè®¡åˆ†æ
- âœ… å®¡æ ¸å‘˜å·¥ä½œè´Ÿè½½ç®¡ç†
- âœ… ä¸ä»»åŠ¡ç®¡ç†ç³»ç»Ÿé›†æˆï¼Œå®¡æ‰¹æµç¨‹è‡ªåŠ¨åŒ–

#### æ ¸å¿ƒæ¥å£
```http
# è·å–ç§Ÿèµç”³è¯·åˆ—è¡¨
GET /api/oa/admin/machines/rental-applications

# è·å–ç§Ÿèµç”³è¯·è¯¦æƒ…
GET /api/oa/admin/machines/rental-applications/{id}

# æ‰¹å‡†ç§Ÿèµç”³è¯·
POST /api/oa/admin/machines/rental-applications/{id}/approve

# æ‹’ç»ç§Ÿèµç”³è¯·
POST /api/oa/admin/machines/rental-applications/{id}/reject

# æ‰¹é‡å®¡æ‰¹
POST /api/oa/admin/machines/rental-applications/batch-approve

# è·å–ç»Ÿè®¡æ•°æ®
GET /api/oa/admin/machines/rental-statistics
```

### 2. è´·æ¬¾ç”³è¯·å®¡æ‰¹å¢å¼ºç³»ç»Ÿ

#### åŠŸèƒ½ç‰¹æ€§
- âœ… æ‰¹é‡å®¡æ‰¹è´·æ¬¾ç”³è¯·
- âœ… è‡ªåŠ¨å®¡æ‰¹é…ç½®ç®¡ç†
- âœ… æŒ‰é£é™©ç­‰çº§ç­›é€‰ç”³è¯·
- âœ… AIè¯„ä¼°å†å²è¿½è¸ª
- âœ… ä»»åŠ¡ç®¡ç†é›†æˆ
- âœ… é«˜çº§ç»Ÿè®¡åˆ†æ

#### æ ¸å¿ƒæ¥å£
```http
# æ‰¹é‡å®¡æ‰¹è´·æ¬¾ç”³è¯·
POST /api/oa/admin/loans/applications/batch-approve

# å¯ç”¨è‡ªåŠ¨å®¡æ‰¹
POST /api/oa/admin/loans/auto-approval/enable

# ç¦ç”¨è‡ªåŠ¨å®¡æ‰¹
POST /api/oa/admin/loans/auto-approval/disable

# è·å–è‡ªåŠ¨å®¡æ‰¹é…ç½®
GET /api/oa/admin/loans/auto-approval/config

# æŒ‰é£é™©ç­‰çº§è·å–ç”³è¯·
GET /api/oa/admin/loans/applications/by-risk-level

# è·å–AIè¯„ä¼°å†å²
GET /api/oa/admin/loans/applications/{id}/ai-assessment-history

# åˆ›å»ºç”³è¯·ä»»åŠ¡
POST /api/oa/admin/loans/applications/create-task

# è·å–ç”³è¯·ç›¸å…³ä»»åŠ¡
GET /api/oa/admin/loans/applications/{id}/tasks

# è·å–é«˜çº§ç»Ÿè®¡
GET /api/oa/admin/loans/advanced-statistics
```

### 3. Difyå·¥ä½œæµè‡ªåŠ¨å®¡æ‰¹é›†æˆ

#### åŠŸèƒ½ç‰¹æ€§
- âœ… è‡ªåŠ¨è´·æ¬¾å®¡æ‰¹å†³ç­–
- âœ… è‡ªåŠ¨å†œæœºç§Ÿèµå®¡æ‰¹
- âœ… é€šè¿‡ /api/internal/dify/task/create æ¥å£æ™ºèƒ½åˆ›å»ºå®¡æ‰¹ä»»åŠ¡è‡³åç«¯ä»»åŠ¡ç³»ç»Ÿ
- âœ… é€šè¿‡ /api/internal/dify/task/status æ¥å£è·Ÿè¸ªåç«¯ä»»åŠ¡çŠ¶æ€
- âœ… é€šè¿‡ /api/internal/dify/task/complete æ¥å£é€šçŸ¥åç«¯ä»»åŠ¡å®Œæˆ

#### æ ¸å¿ƒæ¥å£
```http
# è‡ªåŠ¨å®¡æ‰¹è´·æ¬¾ç”³è¯·
POST /api/internal/dify/loan/auto-approve

# è‡ªåŠ¨å®¡æ‰¹å†œæœºç§Ÿèµ
POST /api/internal/dify/machine/auto-approve-rental

# åˆ›å»ºå®¡æ‰¹ä»»åŠ¡
POST /api/internal/dify/task/create

# è·å–ä»»åŠ¡çŠ¶æ€
POST /api/internal/dify/task/status

# å®Œæˆå®¡æ‰¹ä»»åŠ¡
POST /api/internal/dify/task/complete
```

### 4. ç»Ÿä¸€å®¡æ‰¹ç®¡ç†ç³»ç»Ÿ

#### åŠŸèƒ½ç‰¹æ€§
- âœ… è·¨ä¸šåŠ¡ç±»å‹çš„ç»Ÿä¸€å®¡æ‰¹è§†å›¾
- âœ… æ™ºèƒ½ä»»åŠ¡åˆ†é…
- âœ… å®¡æ ¸å‘˜å·¥ä½œè´Ÿè½½ç›‘æ§
- âœ… æ‰¹é‡æ“ä½œæ”¯æŒ

#### æ ¸å¿ƒæ¥å£
```http
# è·å–å¾…å®¡æ‰¹äº‹é¡¹
GET /api/oa/admin/approvals/pending

# æ‰¹é‡åˆ†é…å®¡æ‰¹ä»»åŠ¡
POST /api/oa/admin/approvals/batch-assign

# è·å–å®¡æ ¸å‘˜å·¥ä½œè´Ÿè½½
GET /api/oa/admin/approvals/workload
```

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### æ–‡ä»¶ç»“æ„
```
backend/internal/
â”œâ”€â”€ handler/
â”‚   â”œâ”€â”€ machine_handler.go           # æ‰©å±•ï¼šå†œæœºç§Ÿèµå®¡æ‰¹åŠŸèƒ½
â”‚   â”œâ”€â”€ oa_loan_handler.go          # æ‰©å±•ï¼šè´·æ¬¾å®¡æ‰¹å¢å¼ºåŠŸèƒ½
â”‚   â”œâ”€â”€ dify_handler.go             # æ‰©å±•ï¼šDifyè‡ªåŠ¨å®¡æ‰¹åŠŸèƒ½
â”‚   â””â”€â”€ approval_integration_handler.go # æ–°å¢ï¼šç»Ÿä¸€å®¡æ‰¹ç®¡ç†
â”œâ”€â”€ service/
â”‚   â””â”€â”€ approval_types.go           # æ–°å¢ï¼šå®¡æ‰¹ç›¸å…³ç±»å‹å®šä¹‰
â””â”€â”€ router/
    â””â”€â”€ router.go                   # æ›´æ–°ï¼šæ·»åŠ æ–°è·¯ç”±
```

### å…³é”®æŠ€æœ¯ç‰¹æ€§

#### 1. æ™ºèƒ½å®¡æ‰¹å†³ç­–å¼•æ“
```go
// è‡ªåŠ¨å®¡æ‰¹å†³ç­–é€»è¾‘
func (h *DifyHandler) AutoApproveLoanApplication(c *gin.Context) {
    // æ ¹æ®é£é™©ç­‰çº§å’Œç½®ä¿¡åº¦å†³å®šæ˜¯å¦è‡ªåŠ¨å®¡æ‰¹
    decision := "manual" // é»˜è®¤äººå·¥å®¡æ ¸
    if req.AutoApprove && req.Confidence >= 0.8 {
        if req.RiskLevel == "low" && req.CreditScore >= 700 {
            decision = "auto_approve"
        } else if req.RiskLevel == "medium" && req.CreditScore >= 650 && req.Confidence >= 0.9 {
            decision = "auto_approve"
        }
    }
    
    // è‡ªåŠ¨æ‹’ç»é«˜é£é™©ç”³è¯·
    if req.RiskLevel == "high" || req.CreditScore < 500 {
        decision = "auto_reject"
    }
}
```

#### 2. æ‰¹é‡æ“ä½œæ”¯æŒ
```go
// æ‰¹é‡å®¡æ‰¹å®ç°
func (h *OALoanHandler) BatchApproveLoanApplications(c *gin.Context) {
    // æ”¯æŒæ‰¹é‡å¤„ç†å¤šä¸ªç”³è¯·
    // æä¾›è¯¦ç»†çš„æ“ä½œç»“æœåé¦ˆ
    // æ”¯æŒéƒ¨åˆ†æˆåŠŸçš„åœºæ™¯å¤„ç†
}
```

#### 3. ç»Ÿä¸€å®¡æ‰¹è§†å›¾
```go
// è·¨ä¸šåŠ¡ç±»å‹çš„ç»Ÿä¸€å®¡æ‰¹ç®¡ç†
func (h *ApprovalIntegrationHandler) GetPendingApprovals(c *gin.Context) {
    // åˆå¹¶è´·æ¬¾ç”³è¯·å’Œå†œæœºç§Ÿèµç”³è¯·
    // ç»Ÿä¸€çš„æ•°æ®æ ¼å¼å’Œæ’åº
    // æ™ºèƒ½ä¼˜å…ˆçº§è®¡ç®—
}
```

## ğŸ“Š æ•°æ®æ¨¡å‹

### æ ¸å¿ƒå®ä½“å…³ç³»
```
å®¡æ‰¹ç”³è¯· (Approval)
â”œâ”€â”€ è´·æ¬¾ç”³è¯· (LoanApplication)
â”œâ”€â”€ å†œæœºç§Ÿèµç”³è¯· (MachineRentalApplication)
â””â”€â”€ å®¡æ‰¹ä»»åŠ¡ (ApprovalTask)

ç”¨æˆ·ä¿¡æ¯ (User)
â”œâ”€â”€ ç”³è¯·äººä¿¡æ¯
â”œâ”€â”€ å®¡æ ¸å‘˜ä¿¡æ¯
â””â”€â”€ ä¿¡ç”¨è¯„ä¼°ä¿¡æ¯

å®¡æ‰¹æµç¨‹ (ApprovalFlow)
â”œâ”€â”€ é£é™©è¯„ä¼° (RiskAssessment)
â”œâ”€â”€ AIè¯„ä¼°å†å² (AIAssessmentHistory)
â””â”€â”€ å®¡æ ¸è®°å½• (ReviewRecord)
```

### çŠ¶æ€æµè½¬
```
ç”³è¯·çŠ¶æ€æµè½¬ï¼š
pending â†’ in_review â†’ approved/rejected/returned

ä»»åŠ¡çŠ¶æ€æµè½¬ï¼š
created â†’ assigned â†’ in_progress â†’ completed/cancelled

è‡ªåŠ¨å®¡æ‰¹æµè½¬ï¼š
submitted â†’ ai_assessment â†’ auto_approve/auto_reject/manual_review
```

## ğŸ”§ é…ç½®è¯´æ˜

### è‡ªåŠ¨å®¡æ‰¹é…ç½®ç¤ºä¾‹
```json
{
  "loan_config": {
    "enabled": true,
    "conditions": {
      "max_amount": 100000,
      "min_credit_score": 650,
      "max_risk_level": "medium",
      "min_confidence": 0.8,
      "user_types": ["farmer", "cooperative"],
      "required_verifications": ["real_name", "bank_card"]
    }
  },
  "rental_config": {
    "enabled": true,
    "conditions": {
      "max_amount": 50000,
      "min_user_score": 70,
      "max_risk_level": "low",
      "min_confidence": 0.7
    }
  }
}
```

### è·¯ç”±é…ç½®
```go
// Difyå†…éƒ¨APIè·¯ç”±
internal.POST("/dify/loan/auto-approve", difyHandler.AutoApproveLoanApplication)
internal.POST("/dify/machine/auto-approve-rental", difyHandler.AutoApproveMachineRental)
internal.POST("/dify/task/create", difyHandler.CreateApprovalTask)

// OAç®¡ç†å‘˜è·¯ç”±
oaAdmin.GET("/approvals/pending", approvalHandler.GetPendingApprovals)
oaAdmin.POST("/approvals/batch-assign", approvalHandler.BatchAssignApprovals)
oaAdmin.GET("/approvals/workload", approvalHandler.GetApprovalWorkload)
```

## ğŸ“ˆ æ€§èƒ½ç‰¹æ€§

### 1. æ‰¹é‡å¤„ç†èƒ½åŠ›
- æ”¯æŒæ‰¹é‡å®¡æ‰¹æ•°ç™¾ä¸ªç”³è¯·
- å¼‚æ­¥å¤„ç†é¿å…è¶…æ—¶
- è¯¦ç»†çš„æ“ä½œç»“æœåé¦ˆ

### 2. æ™ºèƒ½ä»»åŠ¡åˆ†é…
- åŸºäºå®¡æ ¸å‘˜å·¥ä½œè´Ÿè½½çš„æ™ºèƒ½åˆ†é…
- è€ƒè™‘ä¸“ä¸šæŠ€èƒ½åŒ¹é…
- ä¼˜å…ˆçº§å’Œæ—¶æ•ˆæ€§å¹³è¡¡

### 3. å®æ—¶ç›‘æ§
- å®¡æ‰¹è¿›åº¦å®æ—¶è·Ÿè¸ª
- å·¥ä½œè´Ÿè½½åŠ¨æ€ç›‘æ§
- å¼‚å¸¸æƒ…å†µè‡ªåŠ¨å‘Šè­¦

## ğŸ” å®‰å…¨ç‰¹æ€§

### 1. æƒé™æ§åˆ¶
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- æ“ä½œçº§åˆ«çš„æƒé™éªŒè¯
- å®¡è®¡æ—¥å¿—å®Œæ•´è®°å½•

### 2. æ•°æ®ä¿æŠ¤
- æ•æ„Ÿä¿¡æ¯è„±æ•å¤„ç†
- APIè®¿é—®é¢‘ç‡é™åˆ¶
- æ“ä½œè®°å½•å®Œæ•´æ€§éªŒè¯

## ğŸš€ éƒ¨ç½²è¯´æ˜

### 1. ä¾èµ–è¦æ±‚
- Go 1.19+
- Ginæ¡†æ¶
- æ•°æ®åº“è¿æ¥
- Redisç¼“å­˜

### 2. é…ç½®æ–‡ä»¶
```yaml
# config.yaml
dify:
  api_token: "your-dify-api-token"
  
approval:
  auto_approval:
    enabled: true
    max_daily_approvals: 1000
  
task:
  default_timeout: "24h"
  max_concurrent: 100
```

### 3. å¯åŠ¨æ­¥éª¤
```bash
# 1. æ„å»ºé¡¹ç›®
go build -o huinong-backend ./cmd/server

# 2. è¿è¡ŒæœåŠ¡
./huinong-backend

# 3. éªŒè¯æœåŠ¡
curl http://localhost:8080/health
```

## ğŸ“š APIæ–‡æ¡£

å®Œæ•´çš„APIæ–‡æ¡£è¯·å‚è€ƒï¼š
- [OAç³»ç»Ÿç®¡ç†æ¨¡å—APIæ–‡æ¡£](agent/backend/API/oa_management.md)
- [Swaggeræ–‡æ¡£](http://localhost:8080/swagger/index.html)

## ğŸ” æµ‹è¯•è¯´æ˜

### åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹
```bash
# 1. æµ‹è¯•å†œæœºç§Ÿèµå®¡æ‰¹
curl -X GET "http://localhost:8080/api/oa/admin/machines/rental-applications"

# 2. æµ‹è¯•æ‰¹é‡è´·æ¬¾å®¡æ‰¹
curl -X POST "http://localhost:8080/api/oa/admin/loans/applications/batch-approve" \
  -H "Content-Type: application/json" \
  -d '{"application_ids":[1,2,3],"decision":"approve"}'

# 3. æµ‹è¯•Difyè‡ªåŠ¨å®¡æ‰¹
curl -X POST "http://localhost:8080/api/internal/dify/loan/auto-approve" \
  -H "Authorization: Bearer dify-token" \
  -d '{"application_id":"LA001","risk_level":"low","credit_score":750}'
```

## ğŸ“ ç»´æŠ¤è¯´æ˜

### ç›‘æ§æŒ‡æ ‡
- APIå“åº”æ—¶é—´
- å®¡æ‰¹å¤„ç†é‡
- è‡ªåŠ¨å®¡æ‰¹æˆåŠŸç‡
- ç³»ç»Ÿé”™è¯¯ç‡

### æ—¥å¿—ç®¡ç†
- ç»“æ„åŒ–æ—¥å¿—è®°å½•
- æŒ‰çº§åˆ«åˆ†ç±»å­˜å‚¨
- å®šæœŸæ¸…ç†å’Œå½’æ¡£

### æ€§èƒ½ä¼˜åŒ–
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- ç¼“å­˜ç­–ç•¥åº”ç”¨
- å¹¶å‘å¤„ç†èƒ½åŠ›æå‡

## ğŸ¯ åç»­æ‰©å±•

### è®¡åˆ’åŠŸèƒ½
1. **æœºå™¨å­¦ä¹ æ¨¡å‹é›†æˆ**
   - æ›´æ™ºèƒ½çš„é£é™©è¯„ä¼°
   - ä¸ªæ€§åŒ–å®¡æ‰¹ç­–ç•¥
   - é¢„æµ‹æ€§åˆ†æ

2. **ç§»åŠ¨ç«¯æ”¯æŒ**
   - ç§»åŠ¨å®¡æ‰¹åº”ç”¨
   - æ¨é€é€šçŸ¥
   - ç¦»çº¿å®¡æ‰¹èƒ½åŠ›

3. **åŒºå—é“¾é›†æˆ**
   - å®¡æ‰¹è®°å½•ä¸å¯ç¯¡æ”¹
   - æ™ºèƒ½åˆçº¦è‡ªåŠ¨æ‰§è¡Œ
   - è·¨æœºæ„ä¿¡ä»»æœºåˆ¶

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥çœ‹ç›¸å…³æ–‡æ¡£ã€‚

---

**é¡¹ç›®çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2024å¹´1æœˆ15æ—¥